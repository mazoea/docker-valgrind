name: â˜ƒ build-and-publish
on:
  push:
    tags:
      - '*'
  workflow_dispatch:

env:
  IMG_REPO: ghcr.io/mazoea/docker-valgrind
  JOBNAME: build-and-test

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: mazoea/ga-maz/start@master

      - uses: actions/checkout@v4

      - name: pull and build
        run: |
          TAG=${{ env.IMG_REPO }}:${{ github.ref_name }}
          echo "Using TAG:$TAG"

          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker pull $TAG || true
          docker build . -f Dockerfile --tag $TAG --cache-from $TAG

      - name: validate image
        run: |
          TAG=${{ env.IMG_REPO }}:${{ github.ref_name }}
          echo "Validating image: $TAG"
          docker run --rm $TAG --version

      - name: push image
        run: |
          docker push ${{ env.IMG_REPO }} --all-tags
        if: ${{ success() && github.ref_type == 'tag' }}

      - uses: mazoea/ga-maz/end@master
        if: ${{ always() }}
